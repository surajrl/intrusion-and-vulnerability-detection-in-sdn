from nfstream import NFStreamer, NFPlugin
import numpy as np
import pickle
import pandas as pd
import argparse


def run(network_interface_name, output_filepath):

    my_streamer = NFStreamer(
        source=network_interface_name,
        decode_tunnels=False,  # Disable GTP/CAPWAP/TZSP tunnels decoding.
        bpf_filter=None,
        promiscuous_mode=True,  # Enable promiscuous capture mode.
        snapshot_length=1536,  # Control packet slicing size (truncation) in bytes.
        idle_timeout=120,  # Flows that are idle (no packets received) for more than 120 seconds are expired.
        active_timeout=5,  # Flows that are active for more than <active_timeout> seconds are expired.
        accounting_mode=3,  # Accounting mode that will be used to report bytes related features, 3: payload.
        udps=None,
        n_dissections=0,  # Disable L7 visibility feature.
        statistical_analysis=True,  # Enable post-mortem flow statistical analysis.
        splt_analysis=0,
        n_meters=0,
        max_nflows=0,
        performance_report=0,
        system_visibility_mode=0,
        system_visibility_poll_ms=100,
    )

    print(f"Extracting flows from network interface {network_interface_name}.")
    print(f"Flow features saved in {output_filepath}.")

    flows_extracted_count = 0
    try:
        for flow in my_streamer:
            flows_extracted_count += 1
            features = [
                flow.bidirectional_duration_ms,
                flow.bidirectional_packets,
                flow.bidirectional_bytes,
                flow.src2dst_duration_ms,
                flow.src2dst_packets,
                flow.src2dst_bytes,
                flow.dst2src_duration_ms,
                flow.dst2src_packets,
                flow.dst2src_bytes,
                flow.bidirectional_min_ps,
                flow.bidirectional_mean_ps,
                flow.bidirectional_stddev_ps,
                flow.bidirectional_max_ps,
                flow.src2dst_min_ps,
                flow.src2dst_mean_ps,
                flow.src2dst_stddev_ps,
                flow.src2dst_max_ps,
                flow.dst2src_min_ps,
                flow.dst2src_mean_ps,
                flow.dst2src_stddev_ps,
                flow.dst2src_max_ps,
                flow.bidirectional_min_piat_ms,
                flow.bidirectional_mean_piat_ms,
                flow.bidirectional_stddev_piat_ms,
                flow.bidirectional_max_piat_ms,
                flow.src2dst_min_piat_ms,
                flow.src2dst_mean_piat_ms,
                flow.src2dst_stddev_piat_ms,
                flow.src2dst_max_piat_ms,
                flow.dst2src_min_piat_ms,
                flow.dst2src_mean_piat_ms,
                flow.dst2src_stddev_piat_ms,
                flow.dst2src_max_piat_ms,
                flow.bidirectional_syn_packets,
                flow.bidirectional_cwr_packets,
                flow.bidirectional_ece_packets,
                flow.bidirectional_urg_packets,
                flow.bidirectional_ack_packets,
                flow.bidirectional_psh_packets,
                flow.bidirectional_rst_packets,
                flow.bidirectional_fin_packets,
                flow.src2dst_syn_packets,
                flow.src2dst_cwr_packets,
                flow.src2dst_ece_packets,
                flow.src2dst_urg_packets,
                flow.src2dst_ack_packets,
                flow.src2dst_psh_packets,
                flow.src2dst_rst_packets,
                flow.src2dst_fin_packets,
                flow.dst2src_syn_packets,
                flow.dst2src_cwr_packets,
                flow.dst2src_ece_packets,
                flow.dst2src_urg_packets,
                flow.dst2src_ack_packets,
                flow.dst2src_psh_packets,
                flow.dst2src_rst_packets,
                flow.dst2src_fin_packets,
            ]

            # Append flows to file
    finally:
        print(
            f"Total flows extracted from {network_interface_name}: {flows_extracted_count}."
        )


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-i", "--interface", type=str, help="Specify the network interface."
    )
    parser.add_argument(
        "-o",
        "--output",
        type=str,
        help="Specify the flow features extraction output filepath.",
    )
    args = parser.parse_args()

    if not args.interface:
        print("Please provide a network interface using the -i or --interface option.")
        exit()
    if not args.output:
        print(
            "Please provide an output filepath for the flow features extraction using the -o or --output option."
        )
        exit()

    run(args.interface, args.output)
